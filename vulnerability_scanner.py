from scapy.all import rdpcap, IP, TCP, ARP, Dot11, Dot11Deauth
from collections import defaultdict
from cvss_calc import get_cvss_base_score
import re

def detect_ddos(pcap_file):
    threshold = 1000
    packets = rdpcap(pcap_file)

    cve= "CVE-2018-11776"
    cvss_sore = get_cvss_base_score(cve)

    ip_count = defaultdict(int)
    source_count = defaultdict(set)

    for packet in packets:
        if packet.haslayer(IP):
            ip_layer = packet[IP]
            dest_ip = ip_layer.dst
            src_ip = ip_layer.src
            ip_count[dest_ip] += 1
            source_count[dest_ip].add(src_ip)

    detected_ddos_info = []

    for dest_ip, count in ip_count.items():
        if count > threshold:
            num_sources = len(source_count[dest_ip])
            detected_ddos_info.append({
                'ip_tujuan': dest_ip,
                'jumlah_paket': count,
                'sumber_unik': num_sources
            })

    result = {
        'vulnerability_type':'DDoS',
        'message':'DDoS (Distributed Denial of Service) adalah serangan siber yang membanjiri server atau jaringan dengan lalu lintas besar dari banyak perangkat secara bersamaan, sehingga membuat layanan tidak dapat diakses. Serangan ini memanfaatkan banyak perangkat dari lokasi berbeda, sehingga sulit dibedakan dari lalu lintas normal.',
        'number_of_detected': len(detected_ddos_info),
        'metrics': ("N", "L", "N", "N", "C", "N", "N", "H"),
        'cvss_score': cvss_sore,
        'details': detected_ddos_info
    }

    return result

# pcap_file = 'SYN.pcap'
# ddos_result = detect_ddos(pcap_file, threshold)
# print(ddos_result)

def detect_sql_injection(pcap_file):
    packets = rdpcap(pcap_file)

    cve="CVE-2013-0375"
    cvss_sore = get_cvss_base_score(cve)

    # SQL injection patterns
    sql_injection_patterns = [
        r"(?i)select\s.*\sfrom\s.*",
        r"(?i)union\s.*\sselect\s.*",
        r"(?i)or\s+'1'='1'",
        r"(?i)or\s+1=1",
        r"(?i)'\s*or\s*'1'='1",
        r"(?i)'\s*or\s*1=1",
        r"(?i)--"
    ]

    detected_injections = []

    for packet in packets:
        if packet.haslayer(TCP) and packet.haslayer(IP):
            ip_layer = packet[IP]
            tcp_layer = packet[TCP]
            if tcp_layer.dport == 80 or tcp_layer.sport == 80:
                raw_data = bytes(tcp_layer.payload)
                try:
                    data = raw_data.decode('utf-8')
                    for pattern in sql_injection_patterns:
                        if re.search(pattern, data, re.IGNORECASE):
                            detected_injections.append({
                                'ip_sumber': ip_layer.src,
                                'port_sumber': tcp_layer.sport,
                                'ip_tujuan': ip_layer.dst,
                                'port_tujuan': tcp_layer.dport,
                                'pola': repr(pattern),
                            })
                            break
                except UnicodeDecodeError:
                    pass

    result = {
        'vulnerability_type': 'SQL Injection',
        'message': 'SQL Injection adalah kerentanan keamanan yang terjadi ketika penyerang menyisipkan perintah SQL berbahaya ke dalam input aplikasi, seperti formulir atau URL, untuk memanipulasi database. Kerentanan ini dapat digunakan untuk mencuri data sensitif, mengubah informasi, atau bahkan menghapus seluruh database aplikasi yang rentan.',
        'number_of_detected': len(detected_injections),
        'metrics': ("N", "L", "L", "N", "C", "H", "H", "H"),
        'cvss_score':cvss_sore,
        'details': detected_injections
    }

    return result

# result = detect_sql_injection('sql pcap.pcapng')
# print(result)

def detect_brute_force(pcap_file):
    packets = rdpcap(pcap_file)

    cve= "CVE-2017-0144"
    cvss_sore = get_cvss_base_score(cve)

    attempts = {}

    for pkt in packets:
        if pkt.haslayer(TCP):
            ip_src = pkt[IP].src
            ip_dst = pkt[IP].dst
            sport = pkt[TCP].sport
            dport = pkt[TCP].dport

            key = (ip_src, ip_dst, dport)

            if key not in attempts:
                attempts[key] = []

            attempts[key].append({
                'timestamp': pkt.time,
                'source_port': sport
            })

    threshold = 100

    detected_brute_force = []
    for key, logs in attempts.items():
        if len(logs) > threshold:
            detected_brute_force.append({
                'ip_sumber': key[0],
                'ip_tujuan': key[1],
                'port_tujuan': key[2],
                'jumlah_percobaan': len(logs),
            })

    result = {
        'vulnerability_type': 'Brute Force Attack',
        'message': 'Ketika server menerima banyak request yang tidak berhasil, seperti ratusan atau ribuan percobaan login dalam waktu singkat, ini bisa menjadi tanda serangan brute force. Serangan ini bisa menghabiskan sumber daya server, memperlambat kinerja jaringan.',
        'number_of_detected': len(detected_brute_force),
        'metrics': ("N", "L", "N", "N", "U", "L", "L", "N"),
        'cvss_score':cvss_sore,
        'details': detected_brute_force
    }

    return result

def detect_arp_spoofing(pcap_file):
    packets = rdpcap(pcap_file)

    cve= "CVE-2017-17215"
    cvss_sore = get_cvss_base_score(cve)

    arp_table = {}
    detected_arp_spoofing = []

    for packet in packets:
        if packet.haslayer(ARP) and packet[ARP].op == 2:  
            src_ip = packet[ARP].psrc
            src_mac = packet[ARP].hwsrc
            if src_ip in arp_table and arp_table[src_ip] != src_mac:
                detected_arp_spoofing.append({
                    'ip_sumber': src_ip,
                    'mac_sumber': src_mac,
                    'mac_lainnya': arp_table[src_ip],
                    'ringkasan_paket': packet.summary()
                })
            arp_table[src_ip] = src_mac  

    result = {
        'vulnerability_type': 'ARP Spoofing',
        'message': 'ARP spoofing adalah teknik serangan di mana penyerang mengirimkan pesan ARP palsu ke jaringan lokal untuk mengasosiasikan alamat MAC-nya dengan alamat IP yang sah, sehingga mengalihkan lalu lintas data ke perangkatnya. Serangan ini memungkinkan penyerang untuk memonitor, mengubah, atau menghentikan komunikasi antara perangkat yang terhubung di jaringan yang sama.',
        'number_of_detected': len(detected_arp_spoofing),
        'metrics': ("N", "L", "N", "N", "C", "H", "H", "H"),
        'cvss_score':cvss_sore,
        'details': detected_arp_spoofing
    }

    return result

def detect_port_scanning(pcap_file):
    packets = rdpcap(pcap_file)

    cve= "CVE-2017-9805"
    cvss_sore = get_cvss_base_score(cve)

    scan_count = {}
    potential_scan_ips = []

    for packet in packets:
        if packet.haslayer(TCP) and packet.haslayer(IP):
            src_ip = packet[IP].src
            dport = packet[TCP].dport

            if src_ip not in scan_count:
                scan_count[src_ip] = set()

            scan_count[src_ip].add(dport)
    
    for src_ip, ports in scan_count.items():
        if len(ports) > 5:  
            potential_scan_ips.append({
                'ip_sumber': src_ip,
                'total_port_discan': len(ports),
                'port': list(ports)
            })

    result = {
        'vulnerability_type': 'Port Scanning',
        'message': 'Port scanning attack adalah teknik yang digunakan oleh penyerang untuk memindai dan mengeksplorasi port-port yang terbuka di perangkat atau server untuk menemukan celah keamanan yang bisa dieksploitasi. Dengan mengetahui port yang terbuka, penyerang dapat mencoba mengakses layanan yang berjalan di port tersebut dan mencari potensi kerentanannya.',
        'number_of_detected': len(potential_scan_ips),
        'metrics': ("N", "L", "N", "N", "U", "N", "N", "L"),
        'cvss_score': cvss_sore,
        'details': potential_scan_ips
    }
    return result

# print(detect_port_scanning('bruteforce.pcap'))

def detect_deauth_attack(pcap_file):
    packets = rdpcap(pcap_file)
    
    cve= "CVE-2017-13077"
    cvss_sore = get_cvss_base_score(cve)

    deauth_count = 0
    deauth_details = []

    for packet in packets:
        if packet.haslayer(Dot11Deauth):
            deauth_count += 1
            deauth_details.append({
                'mac_sumber': packet[Dot11].addr2,  
                'mac_tujuan': packet[Dot11].addr1,  
                'timestamp': packet.time, 
                'ringkasan_paket': packet.summary() 
            })

    result = {
        'vulnerability_type': 'Deauthentication Attack',
        'message': 'Serangan Deauthentication adalah teknik serangan pada jaringan Wi-Fi di mana penyerang mengirimkan paket deauth untuk memutuskan perangkat dari jaringan. Serangan ini dapat digunakan untuk mengganggu koneksi jaringan atau melakukan serangan Man-in-the-Middle (MITM).',
        'number_of_detected': deauth_count,
        'metrics': ("N", "L", "N", "N", "U", "N", "N", "H"),
        'cvss_score':cvss_sore,
        'details': deauth_details
    }

    return result

# pcap_file = "path_to_your_pcap_file.pcap"
# deauth_result = detect_deauth_attack(pcap_file) 
# print(deauth_result)


def detect_ssh_brute_force_attack(pcap_file):
    packets = rdpcap(pcap_file)
    brute_force_threshold = 100  
    
    cve="CVE-2018-15473"
    cvss_score = get_cvss_base_score(cve)
    failed_attempts = {}

    for packet in packets:
        if packet.haslayer(TCP) and packet.haslayer(IP):
            ip_layer = packet[IP]
            tcp_layer = packet[TCP]
            
            if tcp_layer.dport == 22 or tcp_layer.sport == 22:
                src_ip = ip_layer.src
                
                if src_ip not in failed_attempts:
                    failed_attempts[src_ip] = 0
                if packet.haslayer(TCP) and packet[TCP].flags == 0x14:  
                    failed_attempts[src_ip] += 1

    detected_brute_force = []
    for src_ip, attempts in failed_attempts.items():
        if attempts >= brute_force_threshold:
            detected_brute_force.append({
                'ip_sumber': src_ip,
                'percobaan_gagal': attempts
            })

    result = {
        'vulnerability_type': 'SSH Brute Force Attack',
        'message': 'Serangan brute force pada SSH terjadi ketika seorang penyerang mencoba banyak kombinasi username dan password untuk mendapatkan akses ke server SSH. Banyaknya percakapan gagal dalam waktu singkat bisa menunjukkan upaya brute force. Serangan ini berisiko tinggi karena dapat memberikan akses tidak sah ke server, yang dapat digunakan untuk berbagai tujuan berbahaya.',
        'number_of_detected': len(detected_brute_force),
        'cvss_score': cvss_score,
        'details': detected_brute_force
    }

    return result
# pcap_file = "ssh.pcap"
# result = detect_ssh_brute_force_attack(pcap_file)
# print(result)


